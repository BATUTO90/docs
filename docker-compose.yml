version: "3"
services:
  app:
    build:
      context: .
      args:
        RAILS_ENV: ${RAILS_ENV:-development}
    depends_on:
      - vite
    environment:
      VITE_RUBY_HOST: vite
    ports:
      - "3000:3000"
    volumes:
      - ".:/app"
      - /app/node_modules
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/docs"]
      interval: 10s
      timeout: 30s
      retries: 5

  vite:
    build:
      context: .
      args:
        RAILS_ENV: ${RAILS_ENV:-development}
    entrypoint: bin/vite dev
    environment:
      DEBUG: "*vite*"
      RAILS_ENV: development
      VITE_RUBY_HOST: 0.0.0.0
    ports:
      - "3036:3036"
    volumes:
      - .:/app
      - /app/node_modules

  muffet:
    depends_on:
      app:
        condition: service_healthy
    image: raviqqe/muffet
    command:
      - "http://app:3000/docs"
      - --include=/docs/
      - --exclude=https://github.com/buildkite/docs/
      - --max-connections=10
      - --color=always
