# Terraform

Buildkite Packages provides registry support for Terraform modules.

Once your Terraform registry has been [created](/docs/packages/manage-registries#create-a-registry), you can publish/upload modules (generated from your application's build) to this registry via the `curl` command presented on your Terraform registry's details page.

To view and copy this `curl` command:

1. Select _Packages_ in the global navigation to access the _Registries_ page.
1. Select your Terraform registry on this page.
1. Select _Publish a Terraform Package_ and in the resulting dialog, use the copy icon at the top-right of the code box to copy this curl command and submit it to publish a module to your Terraform registry.

This command provides:

- The specific URL to publish a module to your specific Terraform registry in Buildkite.
- The API write token (generated by Buildkite Packages) required to publish modules to your Terraform registry.

## Publish a module

The following `curl` command (modified as required before submitting) describes the process above to publish a module to your Terraform registry:

```bash
curl -X POST https://buildkitepackages.com/api/v1/repos/{org.slug}/{registry.name}/packages.json \
  -H "Authorization: Bearer $REGISTRY_WRITE_TOKEN" \
  -F "package[package_file]=@<path_to_file>"
```

where:

<%= render_markdown partial: 'packages/org_slug' %>

<%= render_markdown partial: 'packages/terraform_registry_name' %>

- `$REGISTRY_WRITE_TOKEN` is the Buildkite Packages-generated API token required to publish/upload modules to your Terraform registry.

- `<path_to_file>` is the full path required to the module file. If the file is located in the same directory that this command is running from, then no path is required.

For example, to upload the file `my-terraform-module-1.0.1.tgz` from the current directory to the _My-Terraform-modules_ registry in the _My organization_ Buildkite organization, run the `curl` command:

```bash
curl -X POST https://buildkitepackages.com/api/v1/repos/my-organization/my-terraform-modules/packages.json \
  -H "Authorization: Bearer $REPLACE_WITH_MY_REGISTRY_WRITE_TOKEN" \
  -F "package[package_file]=@my-terraform-module-1.0.1.tgz"
```

## Access a module's details

A Terraform module's details can be accessed from this registry using the _Packages_ section of your Terraform registry page.

To access your Terraform module's details page:

1. Select _Packages_ in the global navigation to access the _Registries_ page.
1. Select your Terraform registry on this page.
1. On your Terraform registry page, select the module within the _Packages_ section. The module's details page is displayed.

The module's details page provides the following information in the following sections:

- _Installation_: [installation instructions](#access-a-modules-details-installing-a-module)
- _Contents_ (where available): a list of directories and files contained within the module
- _Details_: a list of checksum values for this module—MD5, SHA1, SHA256, and SHA512
- _About this version_: a brief (metadata) description about the module
- _Details_: details about:

    * the name of the module (typically the file name excluding any version details and extension)
    * the module version
    * the registry the module is located in
    * the module's visibility—whether the module is _Private_ and requires authentication to access, or is publicly accessible
    * the distribution name / version
    * additional optional metadata contained within the module, such as a homepage, licenses, etc.

- _Last pushed_: the date when the last module was uploaded to the registry
- _Total files_: the total number of files (and directories) within the module
- _Dependencies_: the number of dependency modules required by this module
- _Package size_: the storage size (in bytes) of this module
- _Downloads_: the number of times this module has been downloaded

### Downloading a module

A Terraform module can be downloaded from the module's details page.

To download a module:

1. [Access the module's details](#access-a-modules-details).
1. Select _Download_.

### Installing a module

1. [Access the module's details](#access-a-modules-details).
1. Ensure the _Installation_ > _Installation instructions_ section is displayed.
1. If your Terraform registry is private, copy the top section of the code snippet, and paste it into your `~/.terraformrc` configuration file. This code snippet is based on the format:

    ```config
    credentials "buildkitepackages.com" {
      token = "registry-read-token"
    }
    ```

    where:
    * `registry-read-token` is the Buildkite Packages-generated API token required to download packages from your Debian registry.

    **Note:** This step only needs to be conducted once for the life of your Terraform registry.

1. Copy the lower section of the code snippet, and paste it into your Terraform file. This code snippet is based on the format:

    ```terraform
    module "org_slug___registry_name_module_name" {
      source = "buildkitepackages.com/org-slug---registry-name/ksh/all"
      version = "version.number"
    }
    ```

    where:
    * `org_slug` can be derived from the end of your Buildkite URL (in [snake_case](https://en.wikipedia.org/wiki/Letter_case#Snake_case)), after accessing _Pipelines_ in the global navigation of your organization in Buildkite.
    * `registry_name` is the name of your Terraform registry (in snake_case).
    * `module_name` is the name of your Terraform module.
    * `org-slug` can be obtained from the end of your Buildkite URL (in [kebab-case](https://en.wikipedia.org/wiki/Letter_case#Kebab_case)), after accessing _Pipelines_ in the global navigation of your organization in Buildkite.
    * `registry-name` is the name of your Terraform registry (in kebab-case).
    * `version.number` is the version of your Terraform module.

1. Run the Terraform command:

    ```bash
    terraform init
    ```
