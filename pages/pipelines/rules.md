# Rules overview

_Rules_ is a Buildkite feature that can do the following:

<%= render_markdown partial: 'pipelines/rules_summary' %>

> ðŸ“˜
> The _rules_ feature is currently in development, and is enabled on an opt-in basis for early access. To enable rules for your organization, please contact Buildkite's [Support team](https://buildkite.com/support).

## Rule types

Buildkite Pipelines supports two types of rules that allow one pipeline build to:

- [Trigger another pipeline build](#rule-types-pipeline-dot-trigger-build-dot-pipeline).
- [Read the artifacts generated by another pipeline build](#rule-types-pipeline-dot-artifacts-read-dot-pipeline).

### pipeline.trigger_build.pipeline

This rule type allows one pipeline to trigger another, where:

- Both pipelines are in the same or different [clusters](/docs/clusters/overview).
- One pipeline is public and another is private.

**Note:** This rule type overrides the usual [trigger step permissions checks](/docs/pipelines/trigger-step#permissions) on users and teams.

**Rule Document** format:

```json
{
  "rule": "pipeline.trigger_build.pipeline",
  "value": {
    "source_pipeline": "pipeline-uuid-or-slug",
    "target_pipeline": "pipeline-uuid-or-slug",
    "conditions": [
      "source.build.branch == 'main'",
      "source.build.commit == target.trigger.commit"
    ]
  }
}
```

where:

- `source_pipeline` is the UUID or slug of the pipeline that's allowed to trigger another pipeline.
- `target_pipeline` is the UUID or slug of the pipeline that can be triggered by the `source_pipeline` pipeline.
- `conditions` is an optional array of [conditionals](/docs/pipelines/conditionals) that must be met for the trigger to be allowed.

#### Conditions

The optional `conditions` field allows you to specify an array of [conditionals](/docs/pipelines/conditionals) that must be met for the trigger to be allowed. In the example above, the rule would only apply if the source pipeline's build branch is `main` and the commit of the source pipeline's build matches the target pipeline's trigger build commit. If no conditions are specified, the trigger is allowed in all cases between the source and target pipelines.  If the conditions are not met, the trigger is not allowed (even if the default permissions would have allowed it). If multiple conditions are specified, all conditions must be met for the trigger to be allowed. The conditions are evaluated using the [Buildkite conditionals syntax](/docs/pipelines/conditionals).

In the `pipeline.trigger_build.pipeline` rule the available variables for conditions are:

<table>
<tbody>
	<tr>
		<td><code>source.build.*</code></td>
		<td><code>Build</code></td>
		<td>
      <p>The triggering build in the source pipeline (contains the trigger step). This includes all the variables available for a [build](/docs/pipelines/conditionals#variable-and-syntax-reference-variables).</p>
      <p>Example variables available:</p>
      <ul>
				<li><code>source.build.branch</code> - the branch of the source pipeline that the trigger step is targeting.</li>
        <li><code>source.build.commit</code> - the commit of the source pipeline that the trigger step is targeting.</li>
        <li><code>source.build.message</code> - the commit message of the source pipeline that the trigger step is targeting.</li>
			</ul>
    </td>
	</tr>
  <tr>
    <td><code>source.target.branch</code></td>
    <td><code>String</code></td>
    <td>The branch of the target pipeline that the trigger step is targeting.</td>
  </tr>
  <tr>
    <td><code>source.target.commit</code></td>
    <td><code>String</code></td>
    <td>The commit of the target pipeline that the trigger step is targeting.</td>
  </tr>
  <tr>
    <td><code>source.target.message</code></td>
    <td><code>String</code></td>
    <td>The commit message of the target pipeline that the trigger step is targeting.</td>
  </tr>
</tbody>
</table>

Note: Conditions are shown in error messages when access is denied.

Learn more about creating rules in [Manage rules](/docs/pipelines/rules/manage).

#### Example use case: cross-cluster pipeline triggering

Clusters may be used to separate the environments necessary for building and deploying an application. For example, a continuous integration (CI) pipeline has been set up in cluster A and likewise, a continuous deployment (CD) pipeline in cluster B. Ordinarily, pipelines in separate clusters are not able to trigger builds between each other due to the strict isolation of clusters.

However, a `pipeline.trigger_build.pipeline` rule would allow a trigger step in the CI pipeline of cluster A to target the CD pipeline in cluster B. Such rules would allow deployment to be triggered upon a successful CI build, while still maintaining the separation between the CI and CD agents in their respective clusters.

### pipeline.artifacts_read.pipeline

This rule type allows one pipeline to access (that is, with read-only permissions) the artifacts built by another, where:

- Both pipelines are in the same or different [clusters](/docs/clusters/overview).
- One pipeline is public and another is private.

**Rule Document** format:

```json
{
  "rule": "pipeline.artifacts_read.pipeline",
  "value": {
    "source_pipeline": "pipeline-uuid-or-slug",
    "target_pipeline": "pipeline-uuid-or-slug",
    "conditions": [
      "source.build.branch == target.build.branch",
    ]
  }
}
```

where:

- `source_pipeline` is the UUID or slug of the pipeline that's allowed to access the artifacts from another pipeline.
- `target_pipeline` is the UUID or slug of the pipeline whose artifacts can be accessed by jobs in the `source_pipeline` pipeline.
- `conditions` is an optional array of [conditionals](/docs/pipelines/conditionals) that must be met for the access to be allowed.

#### Conditions

The optional `conditions` field allows you to specify an array of [conditionals](/docs/pipelines/conditionals) that must be met for artifact access to be allowed. In the example above, the rule would only apply if the source pipeline's build branch matches the target pipeline's build branch. If no conditions are specified, the access is allowed in all cases between the source and target pipelines. If the conditions are not met, the access is not allowed (even if the default permissions would have allowed it). If multiple conditions are specified, all conditions must be met for the access to be allowed. The conditions are evaluated using the [Buildkite conditionals syntax](/docs/pipelines/conditionals).

In the `pipeline.read_artifacts.pipeline` rule the available variables for conditions are:


<table>
<tbody>
  <tr>
    <td><code>source.build.*</code></td>
    <td><code>Build</code></td>
    <td>
      <p>The build in the source pipeline that is accessing the artifacts. This includes all the variables available for a [build](/docs/pipelines/conditionals#variable-and-syntax-reference-variables).</p>
      <p>Example variables available:</p>
      <ul>
        <li><code>source.build.branch</code> - the branch of the source pipeline that is accessing the artifacts.</li>
        <li><code>source.build.commit</code> - the commit of the source pipeline that is accessing the artifacts.</li>
        <li><code>source.build.message</code> - the commit message of the source pipeline that is accessing the artifacts.</li>
      </ul>
    </td>
  </tr>
  <tr>
    <td><code>target.build.*</code></td>
    <td><code>Build</code></td>
    <td>
      <p>The build in the target pipeline that the artifacts are being accessed from. This includes all the variables available for a [build](/docs/pipelines/conditionals#variable-and-syntax-reference-variables).</p>
      <p>Example variables available:</p>
      <ul>
        <li><code>target.build.branch</code> - the branch of the target pipeline that the artifacts are being accessed from.</li>
        <li><code>target.build.commit</code> - the commit of the target pipeline that the artifacts are being accessed from.</li>
        <li><code>target.build.message</code> - the commit message of the target pipeline that the artifacts are being accessed from.</li>
      </ul>
    </td>
  </tr>
  <tr>
    <td><code>source.request.query</code></td>
    <td><code>String</code></td>
    <td>The query used to search for artifacts in the target build. See [Searching artifacts](https://buildkite.com/docs/agent/v3/cli-artifact#searching-artifacts) for more information on the query syntax.</td>
  </tr>
</tbody>
</table>

Note: Conditions are shown in error messages when access is denied.

#### Example use case: sharing assets between clusters

Artifacts are not accessible between pipelines across different clusters. For example, a deployment pipeline in cluster B cannot ordinarily access artifacts uploaded by a CI pipeline in cluster A.

However, a `pipeline.artifacts_read.pipeline` rule can be used to override this restriction. For example, assets uploaded as artifacts by the CI pipeline would now be accessible to the deployment pipeline via the `buildkite-agent artifact download --build xxx` command.
