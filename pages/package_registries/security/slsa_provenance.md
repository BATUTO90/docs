# Generate and store SLSA Provenance

## Introduction

By using Buildkite Pipelines together with Buildkite Package Registries, you can publish software packages with SLSA Provenance in just four easy steps.

We will be using the following as a starting point for this guide:

- `nova-corp` Buildkite Organization
- `ruby-logger-gem` Pipeline that builds a Ruby Gem
- `ruby-gems` Package Registry to store the gem

While this guide uses Ruby Gems in its examples, the same steps will work for [all supported package ecosystems](/docs/packages/ecosystems) except OCI-based packages like [Container (Docker)](/docs/packages/container) and [Helm OCI](/docs/packages/helm-oci).

## Step 1: Generate SLSA Provenance

[Generate Provenance Attestation](https://github.com/buildkite-plugins/generate-provenance-attestation-buildkite-plugin) plugin generates a SLSA Provenance Attestation for artifacts that have been uploaded to artifact storage in a pipeline step.

Here's a step that builds a gem and uploads it to artifact storage.

```yaml
steps:
  - label: "Build Gem"
    command: "gem build logger.gemspec"
    artifact_paths: "logger-*.gem"
```

A SLSA Provenance Attestation can be generated by adding the plugin to the step:

```yaml
steps:
  - label: "Build Gem"
    command: "gem build logger.gemspec"
    artifact_paths: "logger-*.gem"
    plugins:
      - generate-provenance-attestation#v1.1.0:
          artifacts: "logger-*.gem"
          attestation_name: "gem-attestation.json"
```

In the example above, a SLSA Provenance Attestation will be generated for artifacts matching `logger-*.gem` and be uploaded it to artifact storage as `gem-attestation.json`.

<%= image "artifacts-attestation.png", alt: "Screenshot of Artifacts showing the attestation generated by the Generate Provenance Attestation plugin.", class: "no-decoration" %>

Once this step is complete, `gem-attestation.json` will be available to subsequent steps in the pipeline.

See [an example of a SLSA Provenance Statement](https://github.com/buildkite-plugins/generate-provenance-attestation-buildkite-plugin/blob/d9f2ff4d6b745f17cc55b6b91778a0e1a7d45824/examples/statement.json) that the plugin generates, which is then serialised and uploaded as [a DSSE Envelope](https://github.com/buildkite-plugins/generate-provenance-attestation-buildkite-plugin/blob/d9f2ff4d6b745f17cc55b6b91778a0e1a7d45824/examples/envelope.json) (this is what `gem-attestation.json` looks like).

## Step 2: Publish a package with SLSA Provenance

[Publish to Packages](https://github.com/buildkite-plugins/publish-to-packages-buildkite-plugin/) plugin allows you to quickly and easily publish a package to Package Registries. When the `attestations: ` attribute is set, the package will be published with the specified attestations.

```yaml
steps:
  - label: "Publish Gem"
    plugins:
      - publish-to-packages#v2.2.0:
          artifacts: "logger-*.gem"
          registry: "nova-corp/ruby-gems"
          attestations:
            - "gem-attestation.json"
```

In the example above, artifacts matching `logger-*.gem` will be published to `nova-corp/ruby-gems` Package Registry. Additionally, they will be published with the `gem-attestation.json` attestation.

## Step 3: Set up OIDC Policy

Publish to Packages authenticates with Package Registries using an [Agent OIDC token](/docs/agent/v3/cli-oidc), so an [OIDC policy](/docs/packages/security/oidc#define-an-oidc-policy-for-a-registry) needs to be added to `ruby-gems` Package Registry.

```yaml
- iss: "https://agent.buildkite.com"
  organization_slug: "nova-corp"
  pipeline_slug: "ruby-logger-gem"
```

{: codeblock-file="OIDC Policy for nova-corp/ruby-gems registry"}

In the example above, the policy allows `nova-corp/ruby-logger-gem` pipeline to publish packages to the `ruby-gems` Package Registry.

<%= image "oidc-policy.png", alt: "Screenshot of Artifacts showing the attestation generated by the Generate Provenance Attestation plugin.", class: "no-decoration" %>

## Step 4: All together now

All the steps above come together in a simple pipeline that builds and publishes a Ruby Gem with SLSA Provenance. A [step dependency](/docs/pipelines/dependencies#defining-explicit-dependencies) ensures that the **Publish Gem** step does not start until the **Build Gem** step has finished successfully.

```yaml
steps:
  - label: "Build Gem"
    key: "build-gem"
    command: "gem build logger.gemspec"
    artifact_paths: "logger-*.gem"
    plugins:
      - generate-provenance-attestation#v1.1.0:
          artifacts: "logger-*.gem"
          attestation_name: "gem-attestation.json"

  - label: "Publish Gem"
    depends_on: "build-gem"
    plugins:
      - publish-to-packages#v2.2.0:
          artifacts: "logger-*.gem"
          registry: "nova-corp/ruby-gems"
          attestations:
            - "gem-attestation.json"
```

{: codeblock-file="pipeline.yml"}

This will give us a build that looks something like this:

<%= image "full-pipeline-build.png", alt: "Screenshot of Artifacts showing the attestation generated by the Generate Provenance Attestation plugin.", class: "no-decoration" %>

The SLSA Provenance will be visible under the **Attestations** tab of a package details page.

<%= image "provenance-in-packages.png", alt: "Screenshot of Artifacts showing the attestation generated by the Generate Provenance Attestation plugin.", class: "no-decoration" %>

## Epilogue

- SLSA Provenance can be generated and stored in Buildkite with the help of [Generate Provenance Attestation](https://github.com/buildkite-plugins/generate-provenance-attestation-buildkite-plugin) and [Publish to Packages](https://github.com/buildkite-plugins/publish-to-packages-buildkite-plugin/) plugins.
- Artifacts that are built and published in this way satisfy [SLSA Build Level 1](https://slsa.dev/spec/v1.0/levels#build-l1) requirements. _(SLSA Build Level 2 coming soon!)_
